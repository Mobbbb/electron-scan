<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>控制面板</title>
	<meta
		http-equiv="Content-Security-Policy"
		content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:"
	/>

	<style>
		html {
			height: 100%;
		}
		body {
			font-family: PingFangSC-Regular,PingFang SC,Helvetica Neue,Helvetica,STHeiTi,sans-serif;
			color: #e6e6e6;
			overflow: hidden;
			height: 100%;
    		font-size: 12px;
		}
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		@keyframes show {
			0% {
				transform: translateX(310px);
			}
			100% {
				transform: translateX(0);
			}
		}
		#app {
			width: 100%;
			height: 100%;
			background-color: #2d3036;
			display: flex;
			justify-content: space-between;
		}
		
		.mouseX1, .mouseY1, .mouseX2, .mouseY2, .loopTime, .errorTimes {
			width: 44px;
    		font-size: 12px;
		}
		#start {
			background-color: white;
		}
		button {
    		font-size: 12px;
			cursor: pointer;
		}
		textarea {
			width: 100%;
    		height: 100px;
			outline: none;
		}
		.rule-text {
			width: 180px;
    		height: 70px;
			outline: none;
			font-size: 12px;
		}
		.errorText {
			display: block;
			height:  50px;
			margin: 4px 0;
			font-size: 12px;
			color: red;
		}
		.countText, .errorTips {
			color: red;
		}
		.checkText {
			width: 40px;
		}
		.right {
			width: 100%;
			box-sizing: border-box;
		}
		.left {
			width: 190px;
			flex-shrink: 0;
		}
		.left > div {
			margin-bottom: 4px;
		}
	</style>
</head>

<body>
	<div id="app">
		<div class="left">
			<!-- <div style="display: flex;justify-content: space-between;">
				<div>坐标:<span class="mouseXY">(0, 0)</span></div>
				<div>开启邮箱 <input type="checkbox" id="openMail"></div>
			</div>
			<div>
				1. 点击 <input type="text" value="0" class="mouseX1"> , <input type="text" value="0" class="mouseY1"> <button id="copyBtn1">固定</button>
			</div> -->
			<div>
				1. 报警规则
				<textarea class="rule-text" spellcheck="false" placeholder="示例：
1、{x} > 500 || {x} < 200
2、{x} !== 200
3、{x} > 200 && {x} < 500
"></textarea>
			</div>
			<div>
				2. 连续触发 <input type="text" value="1" class="errorTimes">次后报警
			</div>
			<!-- <div>
				4. 点击 <input type="text" value="0" class="mouseX2"> , <input type="text" value="0" class="mouseY2"> <button id="copyBtn2">固定</button>
			</div> -->
			<div>
				3. 等待时间 <input type="text" value="2000" class="loopTime">
			</div>
			<button id="start">▶️启动</button> <button id="test">识别测试</button>
			<div>
				当前连续错误次数 <span class="countText">0</span>
			</div>
			<div>
				<span class="errorTips"></span>
			</div>
		</div>
		<div class="right">
			<textarea class="textarea" spellcheck="false" placeholder="识别区"></textarea>
			<textarea class="errorText" spellcheck="false" placeholder="报错区"></textarea>
			<div class="recognizeTime">00:00:00</div>
		</div>
	</div>
</body>

<script>
	document.addEventListener('keydown', function(event) {
		if (event.key === 'F12') {
			window.call.openRemindDevTools()
		}
	})

	let loopStatus = false
	let scaleFactor = 1
	let count = 0
	let mouseInfo = {
		x: 0,
		y: 0,
	}
	
	const mouseXY = document.querySelector('.mouseXY') || {}
	const mouseY1 = document.querySelector('.mouseY1') || {}
	const mouseX1 = document.querySelector('.mouseX1') || {}
	const copyBtn1 = document.querySelector('#copyBtn1') || {}

	const mouseY2 = document.querySelector('.mouseY2') || {}
	const mouseX2 = document.querySelector('.mouseX2') || {}
	const copyBtn2 = document.querySelector('#copyBtn2') || {}
	const actionBtn = document.querySelector('#start') || {}
	const closeBtn = document.querySelector('#close') || {}
	const loopTime = document.querySelector('.loopTime') || {}
	const textarea = document.querySelector('.textarea') || {}
	const ruleText = document.querySelector('.rule-text') || {}
	const recognizeTime = document.querySelector('.recognizeTime') || {}
	const isText = document.querySelector('.isText') || {}
	const notText = document.querySelector('.notText') || {}
	const testBtn = document.querySelector('#test') || {}
	const openMailBtn = document.querySelector('#openMail') || {}
	const errorText = document.querySelector('.errorText') || {}
	const countText = document.querySelector('.countText') || {}
	const errorTips = document.querySelector('.errorTips') || {}
	const errorTimes = document.querySelector('.errorTimes') || {}

	// if (localStorage.getItem('mouseX1')) {
	// 	mouseX1.value = localStorage.getItem('mouseX1')
	// }
	// if (localStorage.getItem('mouseY1')) {
	// 	mouseY1.value = localStorage.getItem('mouseY1')
	// }
	// if (localStorage.getItem('mouseX2')) {
	// 	mouseX2.value = localStorage.getItem('mouseX2')
	// }
	// if (localStorage.getItem('mouseY2')) {
	// 	mouseY2.value = localStorage.getItem('mouseY2')
	// }
	if (localStorage.getItem('isText')) {
		isText.value = localStorage.getItem('isText')
	}
	if (localStorage.getItem('notText')) {
		notText.value = localStorage.getItem('notText')
	}
	if (localStorage.getItem('ruleText')) {
		ruleText.value = localStorage.getItem('ruleText')
	}

	// window.listen.mousemove(async ({ x, y }) => {
	// 	mouseXY.innerHTML = `(${x}, ${y})`
	// 	mouseInfo = { x, y }
	// })

	// window.listen.changeCheckBox(async () => {
	// 	openMailBtn.checked = !openMailBtn.checked
	// })

	window.call.getScaleFactor().then(scale => {
		if (scale) scaleFactor = scale
	})

	const speak = (text, config = {}) => {
		let msg = new SpeechSynthesisUtterance(text)
		const {
			volume = 1,
			rate = 1.5,
			pitch = 0.5,
		} = config
		msg.volume = volume
		msg.rate = rate
		msg.pitch = pitch
		msg.voice = speechSynthesis.getVoices()[2]
		speechSynthesis.speak(msg)
	}

	copyBtn1.onclick = () => {
		mouseX1.value = mouseInfo.x - 2
		mouseY1.value = mouseInfo.y - 2
		localStorage.setItem('mouseX1', mouseX1.value)
		localStorage.setItem('mouseY1', mouseY1.value)
	}

	copyBtn2.onclick = () => {
		mouseX2.value = mouseInfo.x - 2
		mouseY2.value = mouseInfo.y - 2
		localStorage.setItem('mouseX2', mouseX2.value)
		localStorage.setItem('mouseY2', mouseY2.value)
	}

	actionBtn.onclick = async () => {
		if (loopStatus) {
			stop()
		} else {
			setCount(0)
			loopStatus = true
			if (isText.value) {
				localStorage.setItem('isText', isText.value)
			}
			if (notText.value) {
				localStorage.setItem('notText', notText.value)
			}
			if (ruleText.value) {
				localStorage.setItem('ruleText', ruleText.value)
			}
			actionBtn.innerHTML = '⏸停止'
			actionBtn.style.background = 'red'
			// imageDom.src = recognizeInfo.image
			// imageDom.style.width = `${recognizeInfo.imgWidth}px`
			// imageDom.style.height = `${recognizeInfo.imgHeight}px`
			loop()
		}
	}

	function stop() {
		loopStatus = false
		textarea.value= ''
		errorText.value= ''
		actionBtn.innerHTML = '▶️启动'
		actionBtn.style.background = 'white'
		setCount(0)
		logText('00:00:00')
	}

	async function loop() {
		if (!loopStatus) return
		await actionHandle()
		if (!loopStatus) return
		await sleep(parseInt(loopTime.value) || 2000, '等待下一轮识别...')
		if (!loopStatus) return
		loop()
	}

	testBtn.onclick = async () => {
		// capture
		await window.call.desktopCapturer()
		// recognize
		const recognizeInfo = await window.call.readImage()

		if (recognizeInfo) {
			textarea.value = recognizeInfo.text
			const formatText = recognizeInfo.text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').toLowerCase()
			logText(new Date(+new Date() + 28800000).toISOString().replace('T', ' ').split('.')[0])
		} else {
			logText('识别模块准备中...')
		}
	}

	async function actionHandle() {
		if (!loopStatus) return
		// open
		// if (mouseX1.value >= 0 && mouseY1.value >= 0) {
		// 	await window.call.mouseTo([mouseX1.value * scaleFactor, mouseY1.value * scaleFactor])
		// 	if (!loopStatus) return
		// 	await sleep(1000, '1.0、等待执行鼠标点击...')
		// 	if (!loopStatus) return
		// 	await window.call.mouseClick()
		// 	if (!loopStatus) return
		// 	await sleep(5000, '1.5、等待执行图片截取...')
		// 	if (!loopStatus) return
		// }

		// capture
		await window.call.desktopCapturer()
		if (!loopStatus) return
		await sleep(1000, '等待执行图片识别...')
		if (!loopStatus) return
		// recognize
		const recognizeInfo = await window.call.readImage()
		if (recognizeInfo && loopStatus) {
			textarea.value = recognizeInfo.text
			const formatText = recognizeInfo.text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').toLowerCase()

			// if (openMailBtn.checked) {
				errorTips.innerHTML = ''
				await sleep(1000, '等待执行报警监测...')
				// send mail
				let rule = ruleText.value.replace(/{x}/g, 'formatText')
				// if (notText.value && isText.value) {
				// 	rule = formatText.indexOf(notText.value) === -1 || formatText.indexOf(isText.value) > -1
				// } else if (notText.value && !isText.value) {
				// 	rule = formatText.indexOf(notText.value) === -1
				// } else if (!notText.value && isText.value) {
				// 	rule = formatText.indexOf(isText.value) > -1
				// }
				if (!rule) {
					setCount(0)
					errorTips.innerHTML = '未设置报警规则!'
					stop()
					return
				}

				let ruleRes = false
				try {
					ruleRes = eval(rule)
				} catch(e) {}
				if (ruleRes) {
					errorTips.innerHTML = ''
					const tempCount = count + 1
					setCount(tempCount)
					if (count >= Number(errorTimes.value)) {
						speak('触发警告！内容为：' + formatText)
						errorText.value = '触发警告！内容为：\n' + formatText + '\n'
							+ new Date(+new Date() + 28800000).toISOString().replace('T', ' ').split('.')[0]
						setCount(0)
						// const res = await window.call.sendMail({
						// 	content: `
						// 		<div style="text-align: center;">
						// 			您的监测内容发生变动<br>
						// 			监测规则为——不包含"${notText.value}" 或者 包含"${isText.value}"<br>
						// 			当前图像的识别文字为 "${textarea.value}"<br>
						// 			当前图像处理后的文字为 "${formatText}"<br>
						// 			快照如下: <br>
						// 			<img src="${recognizeInfo.image}" />
						// 		</div>
						// 	`,
						// })
						// if (res.success) {
						// 	stop()
						// 	textarea.value = '已发送报警，程序终止！'
						// } else {
						// 	errorText.value = '邮件系统错误！ \n' + res.msg
						// }
					}
				}
			// } else {
			// 	errorTips.innerHTML = '当前未开启邮箱报警!'
			// }
		} else {
			logText('识别模块准备中...')
		}
		// close
		if (mouseX2.value >= 0 && mouseY2.value >= 0) {
			if (!loopStatus) return
			await sleep(1000, '3.5、等待执行鼠标移出...')
			if (!loopStatus) return
			await window.call.mouseTo([mouseX2.value * scaleFactor, mouseY2.value * scaleFactor])
			if (!loopStatus) return
			await sleep(1000, '4.0、等待执行鼠标点击...')
			if (!loopStatus) return
			await window.call.mouseClick()
		}
	}

	function sleep(t = 0, log) {
		// logText(log + '<br>' + new Date(+new Date() + 28800000).toISOString().replace('T', ' ').split('.')[0])
		logText(log)
		return new Promise(r => setTimeout(() => r(), t))
	}

	function logText(text) {
		recognizeTime.innerHTML = text
	}

	function setCount(value) {
		count = value
		countText.innerHTML = value
	}

</script>
</html>
