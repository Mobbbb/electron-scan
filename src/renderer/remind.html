<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>控制面板</title>
	<script src="./mock/index.js"></script>
	<style>
		html {
			height: 100%;
		}
		body {
			font-family: PingFangSC-Regular,PingFang SC,Helvetica Neue,Helvetica,STHeiTi,sans-serif;
			color: #e6e6e6;
			overflow: hidden;
			height: 100%;
    		font-size: 12px;
		}
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		@keyframes show {
			0% {
				transform: translateX(310px);
			}
			100% {
				transform: translateX(0);
			}
		}
		#app {
			width: 100%;
			height: 100%;
			background-color: #2d3036;
			display: flex;
			justify-content: space-between;
		}
		
		.mouseX1, .mouseY1, .mouseX2, .mouseY2, .loopTime, .errorTimes {
			width: 44px;
    		font-size: 12px;
		}
		.future-input {
			width: 60px;
    		font-size: 12px;
		}
		#start {
			background-color: white;
		}
		button {
    		font-size: 12px;
			cursor: pointer;
		}
		textarea {
			width: 100%;
    		height: 100px;
			outline: none;
		}
		.rule-text, .gap-rule-text {
			width: 180px;
    		height: 65px;
			outline: none;
			font-size: 12px;
		}
		.errorText {
			display: block;
			height:  50px;
			margin: 4px 0;
			font-size: 12px;
			color: red;
		}
		.countText, .errorTips {
			color: red;
		}
		.checkText {
			width: 40px;
		}
		.right {
			width: 100%;
			box-sizing: border-box;
		}
		.left {
			width: 230px;
			flex-shrink: 0;
		}
		.left > div {
			margin-bottom: 4px;
		}
		.iframe {
			height: 55px;
			position: absolute;
			top: -12px;
			left: 138px;
			visibility: hidden;
		}
	</style>
</head>

<body>
	<div id="app">
		<div class="left">
			<!-- <div style="display: flex;justify-content: space-between;">
				<div>坐标:<span class="mouseXY">(0, 0)</span></div>
				<div>开启邮箱 <input type="checkbox" id="openMail"></div>
			</div>
			<div>
				1. 点击 <input type="text" value="0" class="mouseX1"> , <input type="text" value="0" class="mouseY1"> <button id="copyBtn1">固定</button>
			</div> -->
			<div>
				<label><input name="type" type="radio" value="0" class="type-radio" />规则报警 </label>
				<label><input name="type" type="radio" value="1" class="type-radio" />变化报警 </label>
				<label><input name="type" type="radio" value="2" class="type-radio" />价差报警 </label>
			</div>
			<div class="future-price-area">
				0. <button id="readBtn">读取</button>合约 <input type="text" value="" class="future-input"> 价格
				<iframe src="" frameborder="0" width="90px" class="iframe"></iframe>
			</div>
			<div class="rule-area">
1. 报警规则
<textarea class="rule-text" spellcheck="false" placeholder="示例：
1、{扫描} > 500
2、{扫描} !== 200
3、{扫描} > 200
"></textarea>
			</div>
			<div class="future-area">
1. 报警规则
<textarea class="gap-rule-text" style="height: 50px" spellcheck="false" placeholder="示例：
1、{扫描} - {读取} > 500
2、{扫描} - {读取} < 200
"></textarea>
			</div>
			<div>
				2. 连续触发 <input type="text" value="1" class="errorTimes">次后报警
			</div>
			<!-- <div>
				4. 点击 <input type="text" value="0" class="mouseX2"> , <input type="text" value="0" class="mouseY2"> <button id="copyBtn2">固定</button>
			</div> -->
			<div>
				3. 等待时间 <input type="text" value="2000" class="loopTime">
			</div>
			<button id="start">▶️启动</button> <button id="test">识别测试</button>
			<div>
				当前连续错误次数 <span class="countText">0</span>
			</div>
			<div>
				<span class="errorTips"></span>
			</div>
		</div>
		<div class="right">
			<textarea class="textarea" spellcheck="false" placeholder="识别区"></textarea>
			<textarea class="errorText" spellcheck="false" placeholder="报错区"></textarea>
			<div class="recognizeTime">00:00:00</div>
		</div>
	</div>
</body>

<script>
	const mouseXY = document.querySelector('.mouseXY') || {}
	const mouseY1 = document.querySelector('.mouseY1') || {}
	const mouseX1 = document.querySelector('.mouseX1') || {}
	const copyBtn1 = document.querySelector('#copyBtn1') || {}

	const mouseY2 = document.querySelector('.mouseY2') || {}
	const mouseX2 = document.querySelector('.mouseX2') || {}
	const copyBtn2 = document.querySelector('#copyBtn2') || {}
	const actionBtn = document.querySelector('#start') || {}
	const readBtn = document.querySelector('#readBtn') || {}
	const closeBtn = document.querySelector('#close') || {}
	const loopTime = document.querySelector('.loopTime') || {}
	const textarea = document.querySelector('.textarea') || {}
	const recognizeTime = document.querySelector('.recognizeTime') || {}
	const isText = document.querySelector('.isText') || {}
	const notText = document.querySelector('.notText') || {}
	const testBtn = document.querySelector('#test') || {}
	const openMailBtn = document.querySelector('#openMail') || {}
	const errorText = document.querySelector('.errorText') || {}
	const countText = document.querySelector('.countText') || {}
	const errorTips = document.querySelector('.errorTips') || {}
	const errorTimes = document.querySelector('.errorTimes') || {}
	const typeRadio = document.querySelectorAll('.type-radio') || []
	const ruleText = document.querySelector('.rule-text') || {}
	const gapRuleText = document.querySelector('.gap-rule-text') || {}
	const ruleArea = document.querySelector('.rule-area') || {}
	const futureArea = document.querySelector('.future-area') || {}
	const futurePriceArea = document.querySelector('.future-price-area') || {}
	const futureInput = document.querySelector('.future-input') || {}
	let iframe = document.querySelector('.iframe') || {}
	let warnType = localStorage.getItem('warnType') || '0'
	futureInput.value = localStorage.getItem('future-input-value') || 'EB0'
	
	document.addEventListener('keydown', function(event) {
		if (event.key === 'F12') {
			window.call.openRemindDevTools()
		}
	})
	typeRadio.forEach(item => {
		if (item.value === warnType) { // 初始化
			item.checked = 'checked'
		}
		if (warnType !== '0') {
			ruleArea.style.display = 'none'
		}
		if (warnType !== '2') {
			futureArea.style.display = 'none'
			futurePriceArea.style.display = 'none'
		}
		item.addEventListener('click', (e) => {
			const checkedRadio = document.querySelector('.type-radio:checked')
			warnType = checkedRadio.value
			if (checkedRadio.value === '1') { // 变化报警
				ruleArea.style.display = 'none'
				futureArea.style.display = 'none'
				futurePriceArea.style.display = 'none'
			} else if (checkedRadio.value === '0') { // 规则报警
				ruleArea.style.display = 'block'
				futureArea.style.display = 'none'
				futurePriceArea.style.display = 'none'
			} else if (checkedRadio.value === '2') { // 规则报警
				futureArea.style.display = 'block'
				futurePriceArea.style.display = 'block'
				ruleArea.style.display = 'none'
			}
			localStorage.setItem('warnType', warnType)
			errorText.value = ''
			stop()
		})
	})

	let loopStatus = false
	let scaleFactor = 1
	let count = 0
	let mouseInfo = {
		x: 0,
		y: 0,
	}
	let timeoutCount = 0
	let timeoutMap = {}
	let prevRecognizeInfo = ''
	let iframeDom = null

	// if (localStorage.getItem('mouseX1')) {
	// 	mouseX1.value = localStorage.getItem('mouseX1')
	// }
	// if (localStorage.getItem('mouseY1')) {
	// 	mouseY1.value = localStorage.getItem('mouseY1')
	// }
	// if (localStorage.getItem('mouseX2')) {
	// 	mouseX2.value = localStorage.getItem('mouseX2')
	// }
	// if (localStorage.getItem('mouseY2')) {
	// 	mouseY2.value = localStorage.getItem('mouseY2')
	// }
	if (localStorage.getItem('isText')) {
		isText.value = localStorage.getItem('isText')
	}
	if (localStorage.getItem('notText')) {
		notText.value = localStorage.getItem('notText')
	}
	if (localStorage.getItem('ruleText')) {
		ruleText.value = localStorage.getItem('ruleText')
	}
	if (localStorage.getItem('gapRuleText')) {
		gapRuleText.value = localStorage.getItem('gapRuleText')
	}
	if (localStorage.getItem('loopTime')) {
		loopTime.value = localStorage.getItem('loopTime')
	}
	if (localStorage.getItem('errorTimes')) {
		errorTimes.value = localStorage.getItem('errorTimes')
	}

	// window.listen.mousemove(async ({ x, y }) => {
	// 	mouseXY.innerHTML = `(${x}, ${y})`
	// 	mouseInfo = { x, y }
	// })

	// window.listen.changeCheckBox(async () => {
	// 	openMailBtn.checked = !openMailBtn.checked
	// })

	readBtn.onclick = () => {
		iframe.style.visibility = 'hidden'
		iframe.src = `${prevLink}${futureInput.value}.shtml`
		localStorage.setItem('future-input-value', futureInput.value)
	}

	const getCurrentPrice = () => {
		return parseFloat(iframeDom.getElementsByClassName('real-price')[0]?.innerHTML)
	}

	const setDomStyle = (dom, key, value) => {
		if (dom) {
			dom.style[key] = value
		}
	}
	iframe.src = `${prevLink}${futureInput.value}.shtml`
	iframe.onload = async () => {
		var dom = iframe.contentDocument || iframe.contentWindow.document
		iframeDom = dom
		dom.getElementById('SFA_NV_POP')?.remove()
		dom.getElementById('header')?.remove()
		dom.getElementById('left')?.remove()
		dom.getElementById('financeApp_pics')?.remove()
		dom.getElementById('ny-link-r0')?.remove()
		dom.getElementById('barrageSent')?.remove()
		dom.getElementById('box-calc-area')?.remove()
		dom.getElementsByClassName('side-btns-answer2022')[0]?.remove()
		dom.getElementsByClassName('qrcode-blk-right')[0]?.remove()
		dom.getElementsByClassName('footer')[0]?.remove()
		dom.getElementsByClassName('j-popWrap')[0]?.remove()
		dom.getElementsByClassName('tip-delay')[0]?.remove()
		dom.getElementById('box-month-contract-list-wrap')?.parentNode?.remove()
		dom.getElementById('box-interaction-wrap')?.remove()
		dom.getElementsByClassName('code')[0]?.remove()
		dom.getElementsByClassName('futures-title')[0]?.remove()

		dom.getElementsByTagName('html')[0].style.height = '100%'
		dom.getElementsByTagName('html')[0].style.overflow = 'hidden'
		setDomStyle(dom.getElementsByClassName('arrow')[0], 'background', 'none')
		setDomStyle(dom.getElementsByClassName('trade-time')[0], 'paddingTop', '6px')
		setDomStyle(dom.getElementsByClassName('trade-time')[0], 'borderTop', 'none')
		setDomStyle(dom.getElementsByClassName('title')[0], 'background', 'none')
		setDomStyle(dom.getElementsByClassName('title')[0], 'color', '#303133')
		setDomStyle(dom.getElementsByClassName('title')[0], 'width', '210px')
		setDomStyle(dom.getElementsByClassName('title')[0], 'text-align', 'center')
		setDomStyle(dom.getElementsByClassName('title')[0], 'padding', '0')
		setDomStyle(dom.getElementsByClassName('real-price')[0], 'font-size', '12px')
		setDomStyle(dom.getElementById('container'), 'width', '100%')
		setDomStyle(dom.getElementById('middle'), 'width', '100%')
		setDomStyle(dom.getElementById('right'), 'margin', '0 auto')
		setDomStyle(dom.getElementById('right'), 'float', 'unset')
		setDomStyle(dom.getElementById('right'), 'border-left', 'none')
		setDomStyle(dom.getElementById('table-box-futures-flash'), 'border', 'none')
		setDomStyle(dom.getElementById('box-flash-wrap'), 'margin', '0 auto')
		setDomStyle(dom.getElementById('table-box-futures-flash'), 'display', 'none')

		const style = document.createElement('style')
		style.append(`
		::-webkit-scrollbar
			{
				width: 0;
				height: 0;
				background-color: white;
			}
		`)
		dom.getElementsByTagName('body')[0].append(style)
		
		const segment = dom.getElementsByClassName('segment')
		segment[0]?.remove()
		segment[0]?.remove()
		segment[0]?.remove()
		const section = dom.getElementsByClassName('section')
		section[0]?.remove()
		section[0]?.remove()
		section[0]?.remove()
		iframe.style.visibility = 'visible'
	}

	window.call.getScaleFactor().then(scale => {
		if (scale) scaleFactor = scale
	})

	let speakArr = []
	const speak = (text, config = {}) => {
		if (!speakArr.length) {
			speakArr.push(text)
			speakHandle(config, text)
		} else {
			speakArr.push(text)
		}
	}

	const speakHandle = (config, text) => {
		if (text) {
			let msg = new SpeechSynthesisUtterance(text)
			const {
				volume = 1,
				rate = 1.5,
				pitch = 0.5,
			} = config
			msg.volume = volume
			msg.rate = rate
			msg.pitch = pitch
			msg.voice = speechSynthesis.getVoices()[2]
			msg.onend = function() {
				speechSynthesis.cancel()
				let nextText = speakArr.pop()
				if (speakArr.length) {
					speakArr = []
					speakHandle(config, nextText)
				}
			}
			speechSynthesis.speak(msg)
		}
	}

	copyBtn1.onclick = () => {
		mouseX1.value = mouseInfo.x - 2
		mouseY1.value = mouseInfo.y - 2
		localStorage.setItem('mouseX1', mouseX1.value)
		localStorage.setItem('mouseY1', mouseY1.value)
	}

	copyBtn2.onclick = () => {
		mouseX2.value = mouseInfo.x - 2
		mouseY2.value = mouseInfo.y - 2
		localStorage.setItem('mouseX2', mouseX2.value)
		localStorage.setItem('mouseY2', mouseY2.value)
	}

	actionBtn.onclick = async () => {
		if (loopStatus) {
			stop()
		} else {
			setCount(0)
			loopStatus = true
			if (isText.value) {
				localStorage.setItem('isText', isText.value)
			}
			if (notText.value) {
				localStorage.setItem('notText', notText.value)
			}
			if (ruleText.value) {
				localStorage.setItem('ruleText', ruleText.value)
			}
			if (gapRuleText.value) {
				localStorage.setItem('gapRuleText', gapRuleText.value)
			}
			if (loopTime.value) {
				localStorage.setItem('loopTime', loopTime.value)
			}
			if (errorTimes.value) {
				localStorage.setItem('errorTimes', errorTimes.value)
			}
			actionBtn.innerHTML = '⏸停止'
			actionBtn.style.background = 'red'
			// imageDom.src = recognizeInfo.image
			// imageDom.style.width = `${recognizeInfo.imgWidth}px`
			// imageDom.style.height = `${recognizeInfo.imgHeight}px`
			loop()
		}
	}

	function stop() {
		clearAllTimeout()
		loopStatus = false
		textarea.value= ''
		errorText.value= ''
		actionBtn.innerHTML = '▶️启动'
		actionBtn.style.background = 'white'
		setCount(0)
		logText('00:00:00')
		speechSynthesis.cancel()
	}

	async function loop() {
		if (!loopStatus) return
		await actionHandle()
		if (!loopStatus) return
		await sleep(parseInt(loopTime.value) || 2000, '等待下一轮识别...')
		if (!loopStatus) return
		loop()
	}

	testBtn.onclick = async () => {
		// capture
		await window.call.desktopCapturer()
		// recognize
		const recognizeInfo = await window.call.readImage()

		if (recognizeInfo) {
			textarea.value = recognizeInfo.text
			const formatText = recognizeInfo.text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').toLowerCase()
			logText(new Date(+new Date() + 28800000).toISOString().replace('T', ' ').split('.')[0])
		} else {
			logText('识别模块准备中...')
		}
	}

	async function actionHandle() {
		errorTips.innerHTML = ''
		if (!loopStatus) return

		// capture
		await window.call.desktopCapturer()
		if (!loopStatus) return
		await sleep(1000, '等待执行图片识别...')
		if (!loopStatus) return
		// recognize
		const recognizeInfo = await window.call.readImage()
		if (recognizeInfo && loopStatus) {
			textarea.value = recognizeInfo.text
			const formatText = recognizeInfo.text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').toLowerCase()

			if (warnType === '0') { // 规则报警
				let rule = ruleText.value.replace(/{扫描}/g, 'formatText')
				if (!rule) {
					setCount(0)
					setErrorTips('未设置报警规则!')
					stop()
					return
				}

				let ruleRes = false
				try {
					ruleRes = eval(rule)
				} catch(e) {
					setErrorTips('规则格式错误： ' + e)
					stop()
				}
				if (ruleRes) {
					const tempCount = count + 1
					setCount(tempCount)
					if (count >= Number(errorTimes.value)) {
						speak('触发警告！内容为：' + formatText)
						errorText.value = '触发警告！内容为：\n' + formatText + '\n'
							+ new Date(+new Date() + 28800000).toISOString().replace('T', ' ').split('.')[0]
						setCount(0)
					}
				}
			} else if (warnType === '1') { // 变化报警
				if (!prevRecognizeInfo) { // 初始值
					prevRecognizeInfo = formatText
				}
				if (prevRecognizeInfo !== formatText) {
					speak('触发警告！当前内容为：' + formatText)
						errorText.value = '触发警告！当前内容为：' + formatText + '。之前内容为：' + prevRecognizeInfo + '\n'
							+ new Date(+new Date() + 28800000).toISOString().replace('T', ' ').split('.')[0]
				}
				prevRecognizeInfo = formatText
			} else if (warnType === '2') { // 价差报警
				let readPrice = getCurrentPrice()
				let rule = gapRuleText.value.replace(/{扫描}/g, 'formatText').replace(/{读取}/g, 'readPrice')
				let gapNum = 0
				if (gapRuleText.value.indexOf('扫描') < gapRuleText.value.indexOf('读取')) {
					gapNum = formatText - readPrice
				}
				if (!rule) {
					setCount(0)
					setErrorTips('未设置报警规则!')
					stop()
					return
				}

				let ruleRes = false
				try {
					ruleRes = eval(rule)
				} catch(e) {
					setErrorTips('规则格式错误： ' + e)
					stop()
				}
				if (!isNaN(gapNum)) {
					if (ruleRes) {
						const tempCount = count + 1
						setCount(tempCount)
						if (count >= Number(errorTimes.value)) {
							speak('触发警告！价差为：' + gapNum)
							errorText.value = '触发警告！价差为：\n ' + gapNum + '\n'
								+ new Date(+new Date() + 28800000).toISOString().replace('T', ' ').split('.')[0]
							setCount(0)
						}
					} else {
						errorText.value = '价差： ' + gapNum
					}
				} else {
					errorText.value = '扫描内容为非数字！'
				}
			}
		} else {
			logText('识别模块准备中...')
		}
	}

	function sleep(t = 0, log) {
		logText(log)
		return new Promise(r => {
			timeoutMap[timeoutCount] = setTimeout(() => r(), t)
			timeoutCount++
		})
	}

	function clearAllTimeout() {
		Object.keys(timeoutMap).map(key => {
			clearTimeout(timeoutMap[key])
		})
		timeoutMap = {}
		timeoutCount = 0
	}

	function logText(text) { // 当前执行的步骤
		recognizeTime.innerHTML = text
	}

	function setErrorTips(text) { // 代码报错
		errorTips.innerHTML = text
	}

	function setCount(value) {
		count = value
		countText.innerHTML = value
	}

</script>
</html>
